if(!this['ha_ponder']){this['ha_ponder']={version:"master_9aface6a2e60dd30f1d27464750c13e7a8eb5883_9aface6_SNAPSHOT"}};importScripts("../require.js"),define("type",[],function(){"use strict";function mixin(destination){var sources=Array.prototype.slice.call(arguments,1);return sources.forEach(function(source){for(var i in source)source.hasOwnProperty(i)&&(destination[i]=source[i])}),destination}return function(prototype){var mixins,proto;try{mixins=arguments.length>1?[Object.create(prototype)].concat(Array.prototype.slice.call(arguments,1)):[{},prototype],proto=mixin.apply(null,mixins),proto.constructor.prototype=proto}catch(e){throw console.error("type: Cannot make constructor function and prototype with ",arguments),e}return proto.constructor}}),define("ponder/som/SOM",["type"],function(type){function between(x,s,e){return x>=s&&e>x}function sign(n){return n>=0?1:-1}function ease(t){return t}function toIndex(x,y,width,size){return(width*y+x)*size}function calculateBilinearInterpolant(x1,x,x2,y1,y,y2,Q11,Q21,Q12,Q22){var ans1=(x2-x)*(y2-y)/((x2-x1)*(y2-y1))*Q11,ans2=(x-x1)*(y2-y)/((x2-x1)*(y2-y1))*Q21,ans3=(x2-x)*(y-y1)/((x2-x1)*(y2-y1))*Q12,ans4=(x-x1)*(y-y1)/((x2-x1)*(y2-y1))*Q22;return ans1+ans2+ans3+ans4}return type({constructor:function(options){this._worldWidth=options.width,this._worldHeight=options.height,this._codeBookSize=options.codeBookSize,this._neuralWeights=new Array(this._worldWidth*this._worldHeight*this._codeBookSize);for(var i=0;i<this._neuralWeights.length;i+=1)this._neuralWeights[i]=Math.random();this._mapRadius=Math.max(this._worldWidth,this._worldHeight)/2,this._initialLearningRate=.5},uMatrixNormalized:function(){var distance,total,ni,i,xy={x:0,y:0},min=1/0,max=-(1/0),uMatrix=new Array(this._worldWidth*this._worldHeight);for(i=0;i<this._neuralWeights.length;i+=this._codeBookSize)distance=0,total=0,this.toXY(i,xy),between(xy.x-1,0,this._worldWidth)&&(ni=this.toIndex(xy.x-1,xy.y),distance+=this.distance(this._neuralWeights,i,this._neuralWeights,ni)/this._codeBookSize,total+=1),between(xy.x+1,0,this._worldWidth)&&(ni=this.toIndex(xy.x+1,xy.y),distance+=this.distance(this._neuralWeights,i,this._neuralWeights,ni)/this._codeBookSize,total+=1),between(xy.y-1,0,this._worldHeight)&&(ni=this.toIndex(xy.x,xy.y-1),distance+=this.distance(this._neuralWeights,i,this._neuralWeights,ni)/this._codeBookSize,total+=1),between(xy.y+1,0,this._worldHeight)&&(ni=this.toIndex(xy.x,xy.y+1),distance+=this.distance(this._neuralWeights,i,this._neuralWeights,ni)/this._codeBookSize,total+=1),uMatrix[i/this._codeBookSize]=distance/total,min=Math.min(min,uMatrix[i/this._codeBookSize]),max=Math.max(max,uMatrix[i/this._codeBookSize]);for(i=0;i<uMatrix.length;i+=1)uMatrix[i]=(uMatrix[i]-min)/(max-min);return uMatrix},learn:function(sampleData,fi,ni,learningRate,distance,neighbourhoodDistance){for(var error,influence=1-distance/neighbourhoodDistance,i=0;i<this._codeBookSize;i+=1)error=sampleData[fi+i]-this._neuralWeights[ni+i],this._neuralWeights[ni+i]=this._neuralWeights[ni+i]+learningRate*influence*error},train:function(sampleData,fi,learningRate,neighbourhoodDistance,bmu){this.bmu(sampleData,fi,bmu);for(var i,dist,cstart=Math.max(Math.floor(bmu.x-neighbourhoodDistance),0),cend=Math.min(Math.ceil(bmu.x+neighbourhoodDistance),this._worldWidth),rstart=Math.max(Math.floor(bmu.y-neighbourhoodDistance),0),rend=Math.min(Math.ceil(bmu.y+neighbourhoodDistance),this._worldHeight),c=cstart;cend>c;c+=1)for(var r=rstart;rend>r;r+=1)i=this.toIndex(c,r),dist=Math.sqrt(Math.pow(c-bmu.x,2)+Math.pow(r-bmu.y,2)),neighbourhoodDistance>=dist&&this.learn(sampleData,fi,i,learningRate,dist,neighbourhoodDistance)},interpolate:function(values,targetWidth,targetHeight){for(var x1,x,x2,y1,y,y2,Q11,Q21,Q12,Q22,interpolated=new Array(targetWidth*targetHeight),r=0;targetHeight>r;r+=1)for(var c=0;targetWidth>c;c+=1)x=c*(this._worldWidth-1)/(targetWidth-1),y=r*(this._worldHeight-1)/(targetHeight-1),x1=Math.min(Math.floor(x),this._worldWidth-2),x2=x1+1,y1=Math.min(Math.floor(y),this._worldHeight-2),y2=y1+1,Q11=values[toIndex(x1,y1,this._worldWidth,1)],Q12=values[toIndex(x1,y2,this._worldWidth,1)],Q21=values[toIndex(x2,y1,this._worldWidth,1)],Q22=values[toIndex(x2,y2,this._worldWidth,1)],interpolated[targetWidth*r+c]=calculateBilinearInterpolant(x1,x,x2,y1,y,y2,Q11,Q12,Q21,Q22);return interpolated},trainMap:function(sampleData){this._trainingData=sampleData;var learningRate,neighbourhoodDistance,s,t,iterationLimit=16,bmu={i:0,x:0,y:0};for(s=0;iterationLimit>s;s+=1)for(learningRate=this.learningRate(s,iterationLimit),neighbourhoodDistance=this.neighbourhoodDistance(s,iterationLimit),t=0;t<sampleData.length;t+=this._codeBookSize)this.train(sampleData,t,learningRate,neighbourhoodDistance,bmu)},distance:function(vector1,i1,vector2,i2){for(var sum=0,i=0;i<this._codeBookSize;i+=1)sum+=Math.pow(vector1[i1+i]-vector2[i2+i],2);return sum},learningRate:function(s,iterationLimit){return this._initialLearningRate*(iterationLimit-s)/iterationLimit},neighbourhoodDistance:function(s,iterationLimit){return this._mapRadius*(iterationLimit-s)/iterationLimit},toIndex:function(x,y){return(this._worldWidth*y+x)*this._codeBookSize},toXY:function(index,out){out.x=index/this._codeBookSize%this._worldWidth,out.y=Math.floor(index/this._codeBookSize/this._worldWidth)},jiggerBMU:function(feature,fi,x,y,out){var i,dx=0,dy=0,total=0;between(x-1,0,this._worldWidth)&&(i=this.toIndex(x-1,y),dx-=(1-this.distance(this._neuralWeights,i,feature,fi)/this._codeBookSize)/2,total+=1),between(x+1,0,this._worldWidth)&&(i=this.toIndex(x+1,y),dx+=(1-this.distance(this._neuralWeights,i,feature,fi)/this._codeBookSize)/2,total+=1),between(y-1,0,this._worldHeight)&&(i=this.toIndex(x,y-1),dy-=(1-this.distance(this._neuralWeights,i,feature,fi)/this._codeBookSize)/2,total+=1),between(y+1,0,this._worldHeight)&&(i=this.toIndex(x,y+1),dy+=(1-this.distance(this._neuralWeights,i,feature,fi)/this._codeBookSize)/2,total+=1);var d;between(x-1,0,this._worldWidth)&&between(y-1,0,this._worldHeight)&&(i=this.toIndex(x-1,y-1),d=1-this.distance(this._neuralWeights,i,feature,fi)/this._codeBookSize*1.4142135623730951,dx-=d/2,dy-=d/2,total+=1),between(x-1,0,this._worldWidth)&&between(y+1,0,this._worldHeight)&&(i=this.toIndex(x-1,y+1),d=1-this.distance(this._neuralWeights,i,feature,fi)/this._codeBookSize*1.4142135623730951,dx-=d/2,dy+=d/2,total+=1),between(x+1,0,this._worldWidth)&&between(y-1,0,this._worldHeight)&&(i=this.toIndex(x+1,y-1),d=1-this.distance(this._neuralWeights,i,feature,fi)/this._codeBookSize*1.4142135623730951,dx+=d/2,dy-=d/2,total+=1),between(x+1,0,this._worldWidth)&&between(y+1,0,this._worldHeight)&&(i=this.toIndex(x+1,y+1),d=1-this.distance(this._neuralWeights,i,feature,fi)/this._codeBookSize*1.4142135623730951,dx+=d/2,dy+=d/2,total+=1),out.jx=x+sign(dx)*ease(Math.abs(2*dx)/total)/2,out.jy=y+sign(dy)*ease(Math.abs(2*dy)/total)/2},bmu:function(feature,fi,out){for(var minI,dist,minDistance=1/0,i=0;i<this._neuralWeights.length;i+=this._codeBookSize)dist=this.distance(this._neuralWeights,i,feature,fi,this._codeBookSize),minDistance>dist&&(minDistance=dist,minI=i);out.i=minI,this.toXY(minI,out)},statistics:function(indices){for(var statistics={count:indices.length,mins:new Array(this._codeBookSize),maxs:new Array(this._codeBookSize)},s=0;s<this._codeBookSize;s+=1)statistics.mins[s]=1,statistics.maxs[s]=0;for(var i=0;i<indices.length;i+=1)for(var c=0;c<this._codeBookSize;c+=1)statistics.mins[c]=Math.min(this._trainingData[this._codeBookSize*indices[i]+c],statistics.mins[c]),statistics.maxs[c]=Math.max(this._trainingData[this._codeBookSize*indices[i]+c],statistics.maxs[c]);return statistics},bmus:function(data){for(var out={},results=[],i=0;i<data.length;i+=this._codeBookSize)this.bmu(data,i,out),this.jiggerBMU(data,i,out.x,out.y,out),results.push({x:out.jx,y:out.jy,index:i});return results}})}),require.config({baseUrl:"../../..",paths:{ponder:"src",type:"bower_components/type/type",Promise:"bower_components/Promise/Promise"}}),require(["ponder/som/SOM"],function(SOM){var som=null;addEventListener("message",function(event){switch(event.data.type){case"init":som=new SOM({width:event.data.width,height:event.data.height,codeBookSize:event.data.codeBookSize}),postMessage({type:"initSuccess"});break;case"trainMap":som.trainMap(event.data.data),postMessage({type:"trainMapSucces"});break;case"uMatrixNormalized":postMessage({type:"uMatrixNormalizedSuccess",uMatrix:som.uMatrixNormalized()});break;case"interpolate":postMessage({type:"interpolateSuccess",values:som.interpolate(event.data.values,event.data.targetWidth,event.data.targetHeight)});break;case"bmus":var locations=som.bmus(event.data.data);postMessage({type:"bmusSuccess",locations:locations});break;case"statistics":postMessage({type:"statisticsSuccess",statistics:som.statistics(event.data.indices)})}},!1),postMessage("worker-loaded")}),define("src/som/worker/SOMWorker",function(){});