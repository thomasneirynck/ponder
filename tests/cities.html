<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script src="../bower_components/requirejs/require.js"></script>
    <style>
        html, body {
            margin: 0 auto;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>


<canvas id="som" style="width: 100%; height: 100%; overflow: hidden"></canvas>


<script>

    require({
                baseUrl: "..",
                paths: {
                    'ponder': 'src',
                    'type': "bower_components/type/type",
                    'Promise': "bower_components/Promise/Promise"
                }
            },
            ["ponder/SOM", "ponder/colorRamp", "./cities.js"], function (SOM, colorRamp, cities) {

                var dataOrig = cities.data;
                var codebookSize = 9;
                var width = 64;
                var height = 64;
                var som = new SOM({
                    width: width,
                    height: height,
                    codeBookSize: codebookSize
                });


                var data = new Array(dataOrig.length);
                var min, max;
                for (var i = 0; i < codebookSize; i += 1) {
                    min = Infinity;
                    max = -Infinity;
                    for (var j = 0; j < dataOrig.length / codebookSize; j += 1) {
                        min = Math.min(min, dataOrig[j * codebookSize + i]);
                        max = Math.max(max, dataOrig[j * codebookSize + i]);
                    }
                    for (j = 0; j < data.length / codebookSize; j += 1) {
                        data[j * codebookSize + i] = (dataOrig[j * codebookSize + i] - min) / (max - min);
                    }
                }


                var context2d = document.getElementById("som").getContext("2d");
                context2d.canvas.width = document.body.clientWidth;
                context2d.canvas.height = document.body.clientHeight;

                var buffer = document.createElement("canvas").getContext("2d");
                buffer.canvas.width = width;
                buffer.canvas.height = height;

                var bufferImageData = buffer.getImageData(0, 0, buffer.canvas.width, buffer.canvas.height);

                function fillPixel(weights, wi, pixel, pixeli) {
                    pixel[pixeli] = Math.round(weights[wi] * 255);
                    pixel[pixeli + 1] = Math.round(weights[wi + 1] * 255);
                    pixel[pixeli + 2] = Math.round(weights[wi + 2] * 255);
                    pixel[pixeli + 3] = 255;
                }

                function done() {

                    var out = {};
                    var sx = context2d.canvas.width / width;
                    var sy = context2d.canvas.height / height;
                    for (var i = 0; i < data.length; i += codebookSize) {
                        som.bmu(data, i, out);

                        context2d.fillStyle = "rgb(255,255,255)";


                        som.jiggerBMU(data, i, out.x, out.y, out);
                        context2d.fillRect(out.jx *sx, out.jy * sy, 2, 2);

                        context2d.fillText(cities.labels[i / codebookSize], out.jx * sx, out.jy * sy);

                    }

//                    som.drawU(context2d, sx, sy);


                }

                function progress() {

                    som.averageD(bufferImageData, function (weight, pixel, pixeli) {

                        var color = colorRamp[Math.max(Math.min(colorRamp.length - Math.round(weight * colorRamp.length), colorRamp.length - 1), 0)];
                        if (!color) {
                            debugger;
                        }
                        colors = color.split(",");
                        pixel[pixeli] = colors[0];
                        pixel[pixeli + 1] = colors[1];
                        pixel[pixeli + 2] = colors[2];
                        pixel[pixeli + 3] = 255;
                    });

                    buffer.putImageData(bufferImageData, 0, 0);
                    context2d.drawImage(buffer.canvas, 0, 0, context2d.canvas.width, context2d.canvas.height);

                }

                som.trainMap(data);
                progress();
                done();


            });


</script>


</body>
</html>