<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script src="../bower_components/requirejs/require.js"></script>
    <style>
        html, body {
            margin: 0 auto;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>


<canvas id="som" style="width: 100%; height: 100%; overflow: hidden"></canvas>


<script>

    require({
                baseUrl: "..",
                paths: {
                    'ponder': 'src',
                    'type': "bower_components/type/type",
                    'Promise': "bower_components/Promise/Promise"
                }
            },
            ["ponder/SOMFactory", "ponder/colorRamp", "Promise"], function (SOMFactory, colorRamp, Promise) {


                var data = [
                    [1, 0, 0],
                    [1, 0.12, 0.12],
                    [0, 1, 0],
                    [0, 0.9, 1],
                    [0, 0, 1],
                    [0, 1, 1],
                    [1, 0, 1],
                    [1, 1, 0],
                    [1, 1, 1],
                    [0, 0.2, 0.7],
                    [0.2, 0.7, 0.1],
                    [0, 0.8, 0],
                    [0.9, 0.3, 0]
                ];


                var context2d = document.getElementById("som").getContext("2d");
                context2d.canvas.width = document.body.clientWidth;
                context2d.canvas.height = document.body.clientHeight;

                SOMFactory
                        .makeSOMAsync(data)
                        .then(function (somHandle) {
                            somHandle.trainMap();
                            return {
                                somHandle: somHandle
                            };
                        })
                        .then(function (state) {

                            var buffer = document.createElement("canvas").getContext("2d");
                            buffer.canvas.width = state.somHandle.width;
                            buffer.canvas.height = state.somHandle.height;

                            var bufferImageData = buffer.getImageData(0, 0, buffer.canvas.width, buffer.canvas.height);

                            return Promise
                                    .when(state.somHandle.uMatrix(bufferImageData))
                                    .then(function (data) {
                                        state.pixelBuffer = data.pixelBuffer;
                                        state.buffer = buffer;
                                        return state;
                                    });

                        })
                        .then(function (state) {
                            console.log("got u matrix beeyatch");
                            state.buffer.putImageData(state.pixelBuffer, 0, 0);
                            context2d.drawImage(state.buffer.canvas, 0, 0, context2d.canvas.width, context2d.canvas.height);
                            return Promise.when(state.somHandle.bmus())
                                    .then(function (data) {
                                        state.locations = data.locations;
                                        return state;
                                    });
                        })
                        .then(function (state) {
                            var sx = context2d.canvas.width / state.somHandle.width;
                            var sy = context2d.canvas.height / state.somHandle.height;
                            var size = 2;
                            context2d.fillStyle = "rgb(255,255,255)";
                            for (var i = 0; i < state.locations.length; i += 1) {
                                context2d.fillRect(state.locations[i].x * sx - size / 2, state.locations[i].y * sy - size / 2, size, size);
                            }
                        });


            });


</script>


</body>
</html>